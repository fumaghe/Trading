name: Young Whale Finder (every 20 min)

on:
  schedule:
    - cron: "*/20 * * * *"   # ogni 20 minuti (UTC)
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run-ywf:
    runs-on: ubuntu-latest
    env:
      PYTHONIOENCODING: "utf-8"
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_ID:   ${{ secrets.TG_CHAT_ID }}
      MORALIS_API_KEY: ${{ secrets.MORALIS_API_KEY }}

      # Opzionali:
      YWF_LOG: info
      YWF_FAST: "1"                 # limiti dinamici ON
      YWF_TOPK: "20"
      YWF_TARGET_WALLETS: "12"
      YWF_BUDGET_CALLS: "60"
      YWF_NO_DTB: "1"               # timestamp-only
      YWF_CACHE: "ywf_cache.json"
      YWF_WINDOW_SLACK: "90"
      YWF_RPS: "2"
      YWF_BALANCE_TTL: "0"          # sempre bilanci freschi

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests tenacity rich
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run YWF on 5 tokens (sequential)
        id: ywf
        shell: bash
        run: |
          set -o pipefail
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8

          declare -A TOKENS
          TOKENS["AIA"]="0x48a18A4782b65a0fBed4dcA608BB28038B7bE339"
          TOKENS["BLESS"]="0x7C8217517ed4711fe2DECCdFefFE8d906b9Ae11F"
          TOKENS["B2"]="0x783c3f003f172c6Ac5AC700218a357d2D66Ee2a2"
          TOKENS["LA"]="0x389AD4bb96d0D6EE5B6eF0EFAF4b7db0bA2e02a0"
          TOKENS["RIVER"]="0xdA7AD9dea9397cffdDAE2F8a052B82f1484252B3"
          TOKENS["KGEN"]="0xF3d5b4c34Ed623478cc5141861776E6cf7AE3A1E"

          mkdir -p out

          EXIT_CODE=0
          # ordine fisso (inclusa RIVER)
          for SYM in AIA BLESS B2 LA RIVER KGEN; do
            ADDR="${TOKENS[$SYM]}"
            echo "Running ${SYM} (${ADDR})"
            CMD="python young_whale_finder.py \
              --token ${ADDR} \
              --minutes 21 \
              --min-usd 400 \
              --young-days 5"
            echo "CMD: $CMD"

            OUTJSON="out/out-${SYM}.json"
            ERRFILE="out/err-${SYM}.txt"

            # stdout -> JSON, stderr -> log
            bash -lc "$CMD" 1>"$OUTJSON" 2>"$ERRFILE" || EXIT_CODE=$?

            # Sanitize
            tr -d '\000' < "$OUTJSON" > "out/tmp-${SYM}.json" || true
            mv "out/tmp-${SYM}.json" "$OUTJSON"
            tr -d '\000' < "$ERRFILE" > "out/err-${SYM}.san.txt" || true
            mv "out/err-${SYM}.san.txt" "$ERRFILE"

            # Debug: conteggio results + stats + prime righe stderr
            if command -v jq >/dev/null 2>&1; then
              COUNT=$(jq -r '(.results|length) // 0' "$OUTJSON" 2>/dev/null || echo 0)
              echo "[DEBUG] ${SYM}: results=$COUNT"
              echo -n "[DEBUG] ${SYM}: stats="
              jq -r '" kept=\(.stats.wallet_tenuti // 0) buys_ge_min=\(.stats.buys_ge_min_usd // 0) wallets_seen=\(.stats.wallet_unici_ge_min_usd // 0)"' "$OUTJSON" 2>/dev/null || true
            else
              echo "[WARN] jq non disponibile; salto debug JSON."
            fi
            echo "[DEBUG] ${SYM}: first 20 lines of stderr:"
            head -n 20 "$ERRFILE" || true
            echo "----------------------------------------"
          done

          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

      - name: Build per-wallet Telegram messages (only if results exist)
        shell: bash
        run: |
          mkdir -p out/msgs
          python - << 'PY'
          import os, json, html, glob, time
          from datetime import datetime, timezone

          # SOGLIA: non inviare se balance_usd < 10000
          THRESHOLD = 10000.0

          def fmt_money(v):
              try:
                  return f"${float(v):,.2f}".replace(",", " ")
              except Exception:
                  return str(v)

          def short_addr(a: str) -> str:
              a = (a or "").strip()
              if a.startswith("0x") and len(a) > 10:
                  return a[:6] + "..." + a[-4:]
              return a

          files = sorted(glob.glob("out/out-*.json"))
          total_msgs = 0
          for f in files:
              try:
                  with open(f, "r", encoding="utf-8") as fh:
                      j = json.load(fh)
              except Exception as e:
                  print(f"[DEBUG] skip {f}: {e}")
                  continue

              sym = j.get("symbol") or os.path.basename(f).split("-")[1].split(".")[0]
              token_addr = j.get("token") or ""
              pair = j.get("main_pair_hint") or ""
              results = j.get("results") or []
              if not results:
                  print(f"[DEBUG] {sym}: nessun results nel JSON {f}")
                  continue

              # Link DexScreener: preferisci pair; fallback alla pagina token
              if pair:
                  dex_url = f"https://dexscreener.com/bsc/{pair}"
              else:
                  dex_url = f"https://dexscreener.com/bsc/{token_addr}"

              for r in results:
                  user = r.get("user_name") or "Utente"
                  addr = (r.get("address","") or "").strip()
                  balu = r.get("balance_usd")

                  # --- FILTRO BILANCIO ---
                  try:
                      balf = float(balu)
                  except Exception:
                      balf = None
                  if balf is None or balf < THRESHOLD:
                      print(f"[DEBUG] skip {sym}: {addr} balance_usd={balu} < {THRESHOLD}")
                      continue
                  # ------------------------

                  bought = r.get("sum_buys_usd_window")

                  # Et√† wallet
                  first_ts = r.get("first_tx_ts")
                  age_line = ""
                  if isinstance(first_ts, (int, float)) and first_ts > 0:
                      days = max(0, int((time.time() - float(first_ts)) // 86400))
                      iso_date = datetime.fromtimestamp(first_ts, tz=timezone.utc).strftime("%Y-%m-%d")
                      age_line = f"<i>Wallet creato il {iso_date} ‚Äî {days} giorni</i>"

                  # Link Zerion
                  zerion_url = f"https://debank.com/profile/{addr}"
                  addr_short = short_addr(addr)

                  # Messaggio HTML:
                  header = f'üêã <a href="{dex_url}"><u>{html.escape(sym)}</u></a> ‚Äî <b>{html.escape(user)}</b>'
                  line_buys = f"ü™ô Acquisti nella finestra: <b>{fmt_money(bought)}</b>"
                  line_bal = f"Balance USD: <b>{fmt_money(balu)}</b>"
                  line_addr = f"Wallet: {html.escape(addr_short)}"
                  line_zerion = f'<a href="{zerion_url}">üèõÔ∏è Apri Wallet</a>'

                  # ORDINE: buys -> balance -> wallet -> (age) -> Zerion
                  pieces = [header, line_buys, line_bal, line_addr]
                  if age_line:
                      pieces.append(age_line)
                  pieces.append(line_zerion)

                  txt = "\n".join(pieces)
                  idx = total_msgs + 1
                  out_path = f"out/msgs/msg_{idx:03d}.html"
                  with open(out_path, "w", encoding="utf-8") as m:
                      m.write(txt)
                  print(f"[DEBUG] msg creato per {sym}: {addr} -> {out_path}")
                  total_msgs += 1

          with open("out/msgs/COUNT.txt","w",encoding="utf-8") as f:
              f.write(str(total_msgs))
          PY

      - name: Send Telegram ‚Äî per-wallet messages (only if any)
        if: env.TG_BOT_TOKEN != '' && env.TG_CHAT_ID != ''
        shell: bash
        run: |
          COUNT=$(cat out/msgs/COUNT.txt 2>/dev/null || echo "0")
          if [ "$COUNT" = "0" ]; then
            echo "Nessun wallet trovato sopra soglia: non invio nulla su Telegram."
            exit 0
          fi
          API="https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"
          shopt -s nullglob
          FILES=(out/msgs/msg_*.html)
          for f in "${FILES[@]}"; do
            TEXT="$(cat "$f")"
            curl -sS -X POST "$API" \
              --data-urlencode "chat_id=${TG_CHAT_ID}" \
              --data-urlencode "text=$TEXT" \
              -d "disable_web_page_preview=true" \
              -d "parse_mode=HTML" \
            || echo "Telegram send failed ($f)"
            sleep 0.6
          done

      # Persisti log compatti per il recap 6h
      - name: Persist compact logs for recap (commit to repo)
        shell: bash
        run: |
          set -e
          mkdir -p history
          python - << 'PY'
          import os, json, glob, time
          from datetime import datetime, timezone

          files = sorted(glob.glob("out/out-*.json"))
          now = datetime.now(timezone.utc)
          ts_iso = now.isoformat().replace("+00:00","Z")
          ts_compact = now.strftime("%Y%m%dT%H%M%SZ")

          for f in files:
              with open(f, "r", encoding="utf-8") as fh:
                  j = json.load(fh)

              sym = j.get("symbol") or os.path.basename(f).split("-")[1].split(".")[0]
              token_addr = j.get("token") or ""
              price = j.get("price_usd")
              stats = j.get("stats") or {}
              agg = j.get("agg") or {}
              pair = j.get("main_pair_hint")

              logdoc = {
                  "ts": ts_iso,
                  "symbol": sym,
                  "token": token_addr,
                  "price_usd": price,
                  "main_pair_hint": pair,
                  "window_minutes": j.get("window_minutes"),
                  "stats": stats,
                  "agg": agg
              }

              daydir = os.path.join("history", now.strftime("%Y"), now.strftime("%m"), now.strftime("%d"))
              os.makedirs(daydir, exist_ok=True)
              outp = os.path.join(daydir, f"{sym}-{ts_compact}.json")
              with open(outp, "w", encoding="utf-8") as oh:
                  json.dump(logdoc, oh, ensure_ascii=False, indent=2)
              print("[LOG SAVED]", outp)
          PY

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add history || true
          git commit -m "chore: persist YWF compact logs $(date -u +'%Y-%m-%dT%H:%MZ')" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Upload artifacts (logs & outputs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: young-whale-finder-logs
          path: |
            out/*.json
            out/*.txt
            out/msgs/*.html
            ywf_cache.json
            history/**/*.json
