name: Young Whale Finder (every 20 min)

on:
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: ywf-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run-ywf:
    runs-on: ubuntu-latest
    env:
      PYTHONIOENCODING: "utf-8"
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_ID:   ${{ secrets.TG_CHAT_ID }}
      MORALIS_API_KEY: ${{ secrets.MORALIS_API_KEY }}

      # Opzionali:
      YWF_LOG: info
      YWF_FAST: "1"
      YWF_TOPK: "50"
      YWF_TARGET_WALLETS: "12"
      YWF_BUDGET_CALLS: "60"
      YWF_NO_DTB: "1"
      YWF_CACHE: "ywf_cache.json"
      YWF_WINDOW_SLACK: "90"
      YWF_RPS: "2"
      YWF_BALANCE_TTL: "0"

      # Soglia balance USD per results (script)
      YWF_NAME_MIN_BAL_USD: "1500"

      # NUOVO: soglia TRANSFER (USD) per wallet old (non-vergini)
      YWF_TRANSFER_MIN_USD: "3000"

      # NUOVO: DB persistente wallet (nome + et√† + seen/new)
      YWF_WALLET_DB: "wallet_db.json"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests tenacity rich
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run YWF on tokens (sequential)
        id: ywf
        shell: bash
        run: |
          set -o pipefail
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8

          declare -A TOKENS
          TOKENS["IRYS"]="0x91152B4Ef635403efBAe860edD0F8c321d7c035d"
          TOKENS["AIO"]="0x81a7DA4074b8e0eD51beA40f9dCbDF4d9d4832b4"
          TOKENS["B2"]="0x783c3f003f172c6Ac5AC700218a357d2D66Ee2a2"
          TOKENS["RIVER"]="0xdA7AD9dea9397cffdDAE2F8a052B82f1484252B3"
          TOKENS["BLESS"]="0x7C8217517ed4711fe2DECCdFefFE8d906b9Ae11F"
          TOKENS["STO"]="0xdAf1695c41327b61B9b9965Ac6A5843A3198cf07"
          TOKENS["KGEN"]="0xF3d5b4c34Ed623478cc5141861776E6cf7AE3A1E"
          TOKENS["CYS"]="0x0C69199C1562233640e0Db5Ce2c399A88eB507C7"

          mkdir -p out

          EXIT_CODE=0
          for SYM in IRYS AIO B2 RIVER BLESS STO KGEN CYS; do
            ADDR="${TOKENS[$SYM]}"
            echo "Running ${SYM} (${ADDR})"
            CMD="python young_whale_finder.py \
              --token ${ADDR} \
              --minutes 50 \
              --min-usd 100 \
              --transfer-min-usd ${YWF_TRANSFER_MIN_USD:-3000} \
              --young-days 7 \
              --transfer-young-days 40"
            echo "CMD: $CMD"

            OUTJSON="out/out-${SYM}.json"
            ERRFILE="out/err-${SYM}.txt"

            bash -lc "$CMD" 1>"$OUTJSON" 2>"$ERRFILE" || EXIT_CODE=$?

            tr -d '\000' < "$OUTJSON" > "out/tmp-${SYM}.json" || true
            mv "out/tmp-${SYM}.json" "$OUTJSON"
            tr -d '\000' < "$ERRFILE" > "out/err-${SYM}.san.txt" || true
            mv "out/err-${SYM}.san.txt" "$ERRFILE"

            if command -v jq >/dev/null 2>&1; then
              COUNT=$(jq -r '(.results|length) // 0' "$OUTJSON" 2>/dev/null || echo 0)
              echo "[DEBUG] ${SYM}: results=$COUNT"
              echo -n "[DEBUG] ${SYM}: stats="
              jq -r '" kept=\(.stats.wallet_tenuti // 0) new=\(.stats.wallet_new_in_results // 0) buys_ge_min=\(.stats.buys_ge_min_usd // 0) transfers_ge_min=\(.stats.transfers_ge_min_usd // 0) wallets_seen=\(.stats.wallet_unici_ge_min_usd // 0)"' "$OUTJSON" 2>/dev/null || true
            else
              echo "[WARN] jq non disponibile; salto debug JSON."
            fi
            echo "[DEBUG] ${SYM}: first 20 lines of stderr:"
            head -n 20 "$ERRFILE" || true
            echo "----------------------------------------"
          done

          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

      - name: Build per-wallet Telegram messages (only if results exist)
        shell: bash
        run: |
          mkdir -p out/msgs
          python - << 'PY'
          import os, json, html, glob, time
          from datetime import datetime, timezone

          THRESHOLD = 1500.0

          def fmt_money(v):
              try:
                  return f"${float(v):,.2f}".replace(",", " ")
              except Exception:
                  return str(v)

          def short_addr(a: str) -> str:
              a = (a or "").strip()
              if a.startswith("0x") and len(a) > 10:
                  return a[:6] + "..." + a[-4:]
              return a

          files = sorted(glob.glob("out/out-*.json"))
          total_msgs = 0
          for f in files:
              try:
                  with open(f, "r", encoding="utf-8") as fh:
                      j = json.load(fh)
              except Exception as e:
                  print(f"[DEBUG] skip {f}: {e}")
                  continue

              sym = j.get("symbol") or os.path.basename(f).split("-")[1].split(".")[0]
              token_addr = j.get("token") or ""
              pair = j.get("main_pair_hint") or ""
              results = j.get("results") or []
              if not results:
                  print(f"[DEBUG] {sym}: nessun results nel JSON {f}")
                  continue

              if pair:
                  dex_url = f"https://dexscreener.com/bsc/{pair}"
              else:
                  dex_url = f"https://dexscreener.com/bsc/{token_addr}"

              for r in results:
                  user = r.get("user_name") or "Utente"
                  addr = (r.get("address","") or "").strip()
                  balu = r.get("balance_usd")
                  is_new = bool(r.get("is_new", False))

                  try:
                      balf = float(balu)
                  except Exception:
                      balf = None
                  if balf is None or balf < THRESHOLD:
                      print(f"[DEBUG] skip {sym}: {addr} balance_usd={balu} < {THRESHOLD}")
                      continue

                  trigger = (r.get("trigger") or "").upper().strip()
                  buys = r.get("sum_buys_usd_window")
                  transfers = r.get("sum_transfers_usd_window")
                  tmax = r.get("max_transfer_usd_window")
                  tcnt = r.get("transfers_count_window")
                  tiso = r.get("last_transfer_iso_window") 
                  tts = r.get("last_transfer_ts_window") 

                  first_ts = r.get("first_tx_ts")
                  age_line = ""
                  if isinstance(first_ts, (int, float)) and first_ts > 0:
                      days = max(0, int((time.time() - float(first_ts)) // 86400))
                      iso_date = datetime.fromtimestamp(first_ts, tz=timezone.utc).strftime("%Y-%m-%d")
                      age_line = f"<i>Wallet creato il {iso_date} ‚Äî {days} giorni</i>"

                  debank_url = f"https://debank.com/profile/{addr}"
                  addr_short = short_addr(addr)

                  new_badge = "üö®üÜï " if is_new else ""
                  header = f'{new_badge}üêã <a href="{dex_url}"><u>{html.escape(sym)}</u></a> ‚Äî <b>{html.escape(user)}</b>'

                  lines = [header]

                  # Event lines (BUY / TRANSFER)
                  if "BUY" in trigger and buys is not None:
                      lines.append(f"üü¢ BUY nella finestra: <b>{fmt_money(buys)}</b>")
                  if "TRANSFER" in trigger and transfers is not None:
                      extra = []
                      if tcnt is not None:
                          extra.append(f"n={int(tcnt)}")
                      if tmax is not None:
                          extra.append(f"max={fmt_money(tmax)}")
                      if tiso:
                          extra.append(f"ora={tiso}")
                      else:
                          # fallback: se manca ISO ma c'√® ts, formatta
                          if isinstance(tts, (int, float)) and tts > 0:
                              dt = datetime.fromtimestamp(int(tts), tz=timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
                              extra.append(f"ora={dt}")

                      suffix = f" ({', '.join(extra)})" if extra else ""
                      lines.append(f"üü£ TRANSFER in ingresso: <b>{fmt_money(transfers)}</b>{suffix}")


                  # Always show balance + wallet
                  lines.append(f"Balance USD: <b>{fmt_money(balu)}</b>")
                  lines.append(f"Wallet: {html.escape(addr_short)}")
                  if age_line:
                      lines.append(age_line)
                  lines.append(f'<a href="{debank_url}">üèõÔ∏è Apri Wallet</a>')

                  txt = "\n".join(lines)
                  idx = total_msgs + 1
                  base = f"msg_{idx:03d}"
                  out_path = os.path.join("out", "msgs", base + ".html")
                  meta_path = os.path.join("out", "msgs", base + ".meta.json")

                  with open(out_path, "w", encoding="utf-8") as m:
                      m.write(txt)

                  meta = {
                      "symbol": sym,
                      "token": token_addr,
                      "address": addr,
                      "addr_short": addr_short,
                  }
                  with open(meta_path, "w", encoding="utf-8") as mf:
                      json.dump(meta, mf, ensure_ascii=False)

                  print(f"[DEBUG] msg creato per {sym}: {addr} -> {out_path} (meta: {meta_path})")
                  total_msgs += 1

          with open("out/msgs/COUNT.txt","w",encoding="utf-8") as f:
              f.write(str(total_msgs))
          PY

      - name: Send Telegram ‚Äî per-wallet messages (only if any)
        if: env.TG_BOT_TOKEN != '' && env.TG_CHAT_ID != ''
        shell: bash
        run: |
          COUNT=$(cat out/msgs/COUNT.txt 2>/dev/null || echo "0")
          if [ "$COUNT" = "0" ]; then
            echo "Nessun wallet trovato sopra soglia: non invio nulla su Telegram."
            exit 0
          fi
          API="https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"
          shopt -s nullglob
          FILES=(out/msgs/msg_*.html)
          for f in "${FILES[@]}"; do
            TEXT="$(cat "$f")"
            BASE="${f%.html}"
            META="${BASE}.meta.json"

            if [ -f "$META" ]; then
              REPLY_MARKUP=$(jq -c '{inline_keyboard: [[{text: ("üìã " + (.addr_short // .address)), copy_text: {text: .address}}]]}' "$META")

              curl -sS -X POST "$API" \
                --data-urlencode "chat_id=${TG_CHAT_ID}" \
                --data-urlencode "text=$TEXT" \
                -d "disable_web_page_preview=true" \
                -d "parse_mode=HTML" \
                --data-urlencode "reply_markup=$REPLY_MARKUP" \
              || echo "Telegram send failed ($f)"
            else
              curl -sS -X POST "$API" \
                --data-urlencode "chat_id=${TG_CHAT_ID}" \
                --data-urlencode "text=$TEXT" \
                -d "disable_web_page_preview=true" \
                -d "parse_mode=HTML" \
              || echo "Telegram send failed ($f)"
            fi

            sleep 0.6
          done

      - name: Persist compact logs + wallet DB (commit to repo)
        shell: bash
        run: |
          set -e
          mkdir -p history
          python - << 'PY'
          import os, json, glob
          from datetime import datetime, timezone

          files = sorted(glob.glob("out/out-*.json"))
          now = datetime.now(timezone.utc)
          ts_iso = now.isoformat().replace("+00:00","Z")
          ts_compact = now.strftime("%Y%m%dT%H%M%SZ")

          for f in files:
              try:
                  if os.path.getsize(f) == 0:
                      print(f"[DEBUG] skip {f}: empty file")
                      continue
                  with open(f, "r", encoding="utf-8") as fh:
                      j = json.load(fh)
              except Exception as e:
                  print(f("[DEBUG] skip {f}: {e}"))
                  continue

              if isinstance(j, dict) and j.get("error"):
                  print(f"[DEBUG] skip {f}: error field={j.get('error')}")
                  continue

              sym = j.get("symbol") or os.path.basename(f).split("-")[1].split(".")[0]
              token_addr = j.get("token") or ""
              price = j.get("price_usd")
              stats = j.get("stats") or {}
              agg = j.get("agg") or {}
              pair = j.get("main_pair_hint")

              logdoc = {
                  "ts": ts_iso,
                  "symbol": sym,
                  "token": token_addr,
                  "price_usd": price,
                  "main_pair_hint": pair,
                  "window_minutes": j.get("window_minutes"),
                  "stats": stats,
                  "agg": agg,
              }

              daydir = os.path.join("history", now.strftime("%Y"), now.strftime("%m"), now.strftime("%d"))
              os.makedirs(daydir, exist_ok=True)
              outp = os.path.join(daydir, f"{sym}-{ts_compact}.json")
              with open(outp, "w", encoding="utf-8") as oh:
                  json.dump(logdoc, oh, ensure_ascii=False, indent=2)
              print("[LOG SAVED]", outp)

          PY

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # evita conflitti banali
          git pull --rebase || true

          git add history || true
          git add wallet_db.json || true

          git commit -m "chore: persist YWF logs + wallet_db $(date -u +'%Y-%m-%dT%H:%MZ')" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Upload artifacts (logs & outputs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: young-whale-finder-logs
          path: |
            out/*.json
            out/*.txt
            out/msgs/*.html
            out/msgs/*.meta.json
            out/msgs/COUNT.txt
            ywf_cache.json
            wallet_db.json
            history/**/*.json
