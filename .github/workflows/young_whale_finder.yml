name: Young Whale Finder (every 20 min)

on:
  schedule:
    - cron: "*/20 * * * *"   # ogni 20 minuti (UTC)
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run-ywf:
    runs-on: ubuntu-latest
    env:
      PYTHONIOENCODING: "utf-8"
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_ID:   ${{ secrets.TG_CHAT_ID }}
      MORALIS_API_KEY: ${{ secrets.MORALIS_API_KEY }}

      # Opzionali:
      YWF_LOG: info
      YWF_FAST: "1"                 # limiti dinamici ON
      YWF_TOPK: "20"
      YWF_TARGET_WALLETS: "12"
      YWF_BUDGET_CALLS: "60"
      YWF_NO_DTB: "1"               # timestamp-only
      YWF_CACHE: "ywf_cache.json"
      YWF_WINDOW_SLACK: "90"
      YWF_RPS: "2"
      YWF_BALANCE_TTL: "0"          # sempre bilanci freschi

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests tenacity rich

      - name: Run YWF on 4 tokens (sequential)
        id: ywf
        shell: bash
        run: |
          set -o pipefail
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8

          declare -A TOKENS
          TOKENS["AIA"]="0x48a18A4782b65a0fBed4dcA608BB28038B7bE339"
          TOKENS["BLESS"]="0x7C8217517ed4711fe2DECCdFefFE8d906b9Ae11F"
          TOKENS["B2"]="0x783c3f003f172c6Ac5AC700218a357d2D66Ee2a2"
          TOKENS["LA"]="0x389AD4bb96d0D6EE5B6eF0EFAF4b7db0bA2e02a0"

          mkdir -p out

          EXIT_CODE=0
          # ordine fisso
          for SYM in AIA BLESS B2 LA; do
            ADDR="${TOKENS[$SYM]}"
            echo "Running ${SYM} (${ADDR})"
            CMD="python young_whale_finder.py \
              --token ${ADDR} \
              --minutes 20 \
              --min-usd 600 \
              --young-days 300"
            echo "CMD: $CMD"

            OUTJSON="out/out-${SYM}.json"
            ERRFILE="out/err-${SYM}.txt"

            bash -lc "$CMD" 1>"$OUTJSON" 2>"$ERRFILE" || EXIT_CODE=$?

            # Sanitize
            tr -d '\000' < "$OUTJSON" > "out/tmp-${SYM}.json" || true
            mv "out/tmp-${SYM}.json" "$OUTJSON"
            tr -d '\000' < "$ERRFILE" > "out/err-${SYM}.san.txt" || true
            mv "out/err-${SYM}.san.txt" "$ERRFILE"

            # --- Isola l'oggetto JSON pulito da eventuali log su stdout ---
            OUT="$OUTJSON" python - << 'PY' || true
import os, json
fn = os.environ["OUT"]
data = open(fn, "r", encoding="utf-8", errors="ignore").read()
start = data.find("{")
end   = data.rfind("}")
if start != -1 and end != -1 and end >= start:
    blob = data[start:end+1]
    try:
        json.loads(blob)
        open(fn, "w", encoding="utf-8").write(blob)
        print(f"[DEBUG] JSON isolato e valido in {fn}")
    except Exception as e:
        print(f"[WARN] JSON non valido dopo isolamento in {fn}: {e}")
else:
    print(f"[WARN] Nessun blocco JSON trovato in {fn}")
PY
            # --------------------------------------------------------------

            # Debug: conteggio results + stats + prime righe stderr
            if command -v jq >/dev/null 2>&1; then
              COUNT=$(jq -r '(.results|length) // 0' "$OUTJSON" 2>/dev/null || echo 0)
              echo "[DEBUG] ${SYM}: results=$COUNT"
              echo -n "[DEBUG] ${SYM}: stats="
              jq -r '" kept=\(.stats.wallet_tenuti // 0) buys_ge_min=\(.stats.buys_ge_min_usd // 0) wallets_seen=\(.stats.wallet_unici_ge_min_usd // 0)"' "$OUTJSON" 2>/dev/null || true
            else
              echo "[WARN] jq non disponibile; salto debug JSON."
            fi
            echo "[DEBUG] ${SYM}: first 20 lines of stderr:"
            head -n 20 "$ERRFILE" || true
            echo "----------------------------------------"
          done

          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

      - name: Build per-wallet Telegram messages (only if results exist)
        shell: bash
        run: |
          mkdir -p out/msgs
          python - << 'PY'
          import os, json, html, glob

          def fmt_money(v):
              try:
                  return f"${float(v):,.2f}".replace(",", " ")
              except Exception:
                  return str(v)

          files = sorted(glob.glob("out/out-*.json"))
          total_msgs = 0
          for f in files:
              try:
                  with open(f, "r", encoding="utf-8") as fh:
                      j = json.load(fh)
              except Exception as e:
                  print(f"[DEBUG] skip {f}: {e}")
                  continue

              sym = j.get("symbol") or os.path.basename(f).split("-")[1].split(".")[0]
              results = j.get("results") or []
              if not results:
                  print(f"[DEBUG] {sym}: nessun results nel JSON {f}")
                  continue

              for r in results:
                  user = r.get("user_name") or "Utente"
                  addr = r.get("address","")
                  balu = r.get("balance_usd")
                  bought = r.get("sum_buys_usd_window")
                  lines = []
                  lines.append(f"<b>{html.escape(sym)}</b> — <b>{html.escape(user)}</b> <i>(possibile wallet whale)</i>")
                  lines.append(f"Acquisti nella finestra: <b>{fmt_money(bought)}</b>")
                  lines.append(f"Address: <code>{html.escape(addr)}</code>")
                  lines.append(f"Balance USD: <b>{fmt_money(balu)}</b>")
                  txt = "\n".join(lines)

                  idx = total_msgs + 1
                  out_path = f"out/msgs/msg_{idx:03d}.html"
                  with open(out_path, "w", encoding="utf-8") as m:
                      m.write(txt)
                  print(f"[DEBUG] msg creato per {sym}: {addr} -> {out_path}")
                  total_msgs += 1

          with open("out/msgs/COUNT.txt","w",encoding="utf-8") as f:
              f.write(str(total_msgs))
          PY

      - name: Send Telegram — per-wallet messages (only if any)
        if: env.TG_BOT_TOKEN != '' && env.TG_CHAT_ID != ''
        shell: bash
        run: |
          COUNT=$(cat out/msgs/COUNT.txt 2>/dev/null || echo "0")
          if [ "$COUNT" = "0" ]; then
            echo "Nessun wallet trovato: non invio nulla su Telegram."
            exit 0
          fi

          API="https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"
          shopt -s nullglob
          FILES=(out/msgs/msg_*.html)
          for f in "${FILES[@]}"; do
            TEXT="$(cat "$f")"
            curl -sS -X POST "$API" \
              --data-urlencode "chat_id=${TG_CHAT_ID}" \
              --data-urlencode "text=$TEXT" \
              -d "disable_web_page_preview=true" \
              -d "parse_mode=HTML" \
            || echo "Telegram send failed ($f)"
            sleep 0.6
          done

      - name: Upload artifacts (logs & outputs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: young-whale-finder-logs
          path: |
            out/*.json
            out/*.txt
            out/msgs/*.html
            ywf_cache.json
